<html>
  <head>
    <title>GAnalyse - Syncro Check</title>
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="/js.cookie.js"></script>
    <style>
      table {
        display: inline;
        margin-right: 10px;
      }

      div {
        margin-bottom: 30px;
      }

      .av0 {
       background-color: red;
      }
      .av5 {
       background-color: yellow;
      }
      .av10 {
       background-color: green;
      }

      .pcontinue {
        background: green;
      }

      .pdeny {
        background: yellow;
      }

      .pdeny.outofstock {
        background: red;
      }
    </style>
  </head>
  <body>
    <h1>Syncro Check</h1>

    <form action="/extract">
      <input name="store" value="playmaker">
      <input name="namespace" value="playmakers-sync">
      <input id="key" name="key">
      <input id="pass" name="pass">
      <input id="sub" type="submit">
    </form>

    <div id="result"></div>

    <script>
      function renderProduct(product) {
        var variants = {},
        mainNode = $('<table border="1"></table>');
        header = $("<tr>").appendTo(mainNode)
        sizes = {},
        defaultSizes = [];

        $.each(product.Variants, function(key, variant) {
          key1 = (variant.Color != "") ? variant.Color : variant.Position;
          key2 = (variant.Size != "") ? variant.Size : variant.Position;

          if (!variants[key1]) {
            variants[key1] = {};
          }
          variants[key1][key2] = variant;
          sizes[key2] = true;
        });

        defaultSizes = Object.keys(sizes);

        header.append($('<th><a target="_blank" href="' + product.Origin + '">origin</a></th>'));
        $.each(defaultSizes, function(key, size) {
          header.append($("<th>" + size + "</th>"));
        });

        $.each(variants, function(color, d) {
          node = $("<tr>");
          node.append($("<td><b>" + color + "</b></td>"));

          $.each(defaultSizes, function(key, size) {
            var variant = d[size],
            value, className;

            if(variant) {
              outofstock = (variant.Quantity < 1) ? " outofstock" : "";
              if (variant.Quantity || variant.Quantity == 0) {
                value = variant.Quantity;
                className = 'p'+ variant.Policy + outofstock;
              } else {
                value = variant.Availability;
                className = 'av'+ variant.Availability;
              }
              node.append($('<td class="' + className + '">' + value + '</td>'));
            } else {
              node.append($('<td>-</td>'));
            }

          });
          node.appendTo(mainNode)
        });

        return mainNode;
      }

      $( document ).ready(function() {
        var key = Cookies.get('key'),
        pass = Cookies.get('pass');

        if (key) { $("#key").val(key) }
        if (pass) { $("#pass").val(pass) }

        $("#sub").on('click', function(event) {
          event.preventDefault();

          Cookies.set('key', $("#key").val());
          Cookies.set('pass', $("#pass").val());

          $.ajax({
            url: "/urls?" + $("form").serialize(),
            success: function( repsonse ) {
              $("#result").html("");
              $.each(repsonse, function(url, product) {
                if (product != null) {
                  var node = $('<div><h3>' + product.Name + '</h3></div>').appendTo("#result");
                  product.Origin = 'https://playmaker.myshopify.com/admin/products/' + product.Id;

                  node.append(renderProduct(product));
                  $.each(product.VendorProducts, function(key, product) {
                    node.append(renderProduct(product));
                  });
                }
              });
            }
          });

        });
      });
    </script>

  </body>
</html>
